<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêâ</text></svg>">
    <title>D&D Hero Sheet v17 (Cloud Sync)</title>
    <style>
        /* === 1. –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò (–ü–ö) === */
        :root { --gold: #d4af37; --bg: #1a1a1a; --card: #2d2d2d; --text: #e0e0e0; --red: #c0392b; --green: #27ae60; --blue: #2980b9; --purple: #9b59b6; --dark-input: #111; --tab-inactive: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; min-height: 90vh;}
        h1, h2, h3 { color: var(--gold); border-bottom: 1px solid var(--gold); padding-bottom: 5px; margin-top: 0; }
        h3 { font-size: 1.1rem; border-bottom: 1px dashed #555; margin-top: 20px; margin-bottom: 15px; }

        /* –¢–∞–±—ã */
        .tabs-nav { display: flex; gap: 5px; border-bottom: 2px solid #444; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn {
            background: var(--tab-inactive); color: #888; border: none; padding: 10px 20px; 
            cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 1rem; flex-grow: 1; transition: all 0.2s;
        }
        .tab-btn:hover { background: #3d3d3d; color: var(--gold); }
        .tab-btn.active { background: var(--card); color: var(--gold); border: 2px solid #444; border-bottom: 2px solid var(--card); margin-bottom: -2px; }
        .tab-pane { display: none; animation: fadeIn 0.3s ease; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Header */
        .header-grid { display: grid; grid-template-columns: 140px 1fr; gap: 20px; margin-bottom: 20px; }
        .avatar-box { width: 140px; height: 140px; border: 2px dashed var(--gold); display: flex; align-items: center; justify-content: center; background-size: cover; background-position: center; cursor: pointer; border-radius: 8px; overflow: hidden; background-color: #222; }
        .header-main { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .header-inputs { flex-grow: 1; }
        .level-badge { background: #222; border: 2px solid var(--gold); border-radius: 8px; padding: 5px; text-align: center; min-width: 100px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .lvl-title { font-size: 0.7rem; color: #888; text-transform: uppercase; display: block; }
        .lvl-val { font-size: 2.5rem; line-height: 1; color: var(--gold); font-weight: bold; display: block; margin: 2px 0; }
        .xp-display { font-size: 0.8rem; color: #ccc; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .xp-control { display: flex; gap: 3px; justify-content: center; }
        .xp-control input { width: 50px; padding: 2px; font-size: 0.8rem; text-align: center; background: #111; border: 1px solid #444; color: white; border-radius: 4px; }
        .xp-control button { background: var(--green); border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; padding: 0 8px; }

        /* Vitals */
        .vitals-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .vital-box input { font-size: 1.4rem; font-weight: bold; text-align: center; color: #fff; border: 1px solid #555; background: #333; padding: 5px; border-radius: 4px; width: 100%; }
        .hp-box input { color: #ff7675; border-color: var(--red); }
        .ac-box input { color: #74b9ff; border-color: var(--blue); }

        /* Stats */
        .stats-bar { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 20px; }
        .stat-card { background: #3d3d3d; padding: 10px 5px; border-radius: 6px; text-align: center; border-bottom: 3px solid var(--gold); }
        .stat-row { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .stat-card input.stat-val { width: 60%; background: transparent; border: none; color: white; text-align: right; font-size: 1.6rem; font-weight: bold; margin: 0; padding: 0; }
        .stat-card input.stat-temp { width: 35%; background: #222; border: 1px solid var(--blue); color: var(--blue); text-align: center; font-size: 0.9rem; font-weight: bold; border-radius: 4px; padding: 2px; }
        .stat-mod { display: block; font-size: 1.2rem; color: var(--gold); font-weight: bold; background: #222; border-radius: 4px; margin: 5px auto 0; width: 80%; }

        /* Lists */
        .bonuses-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .bonus-item { display: flex; gap: 5px; background: #333; padding: 5px; border-radius: 4px; align-items: center; border-left: 3px solid var(--blue); }
        .bonus-item input[type="text"] { font-weight: bold; }
        .bonus-item input[type="number"] { width: 50px; text-align: center; color: var(--gold); font-size: 0.9rem; }
        .traits-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .trait-card { background: #2d2d2d; border: 1px solid #444; border-radius: 4px; padding: 8px; display: flex; flex-direction: column; gap: 5px; position: relative; }
        .trait-card input { font-weight: bold; color: var(--gold); text-align: center; border: none; background: #222; }
        .trait-card textarea { resize: none; height: 60px; font-size: 0.85rem; border: none; background: #222; color: #ccc; width: 100%; box-sizing: border-box; font-family: inherit; }
        .trait-del { position: absolute; top: 0; right: 0; background: var(--red); color: white; border: none; font-size: 0.7rem; cursor: pointer; opacity: 0; width: 20px; height: 20px; border-radius: 0 4px 0 4px; }
        .trait-card:hover .trait-del { opacity: 1; }

        /* Magic */
        .spells-wrapper { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .spell-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .spell-slot-card { background: #2d2d2d; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #444; transition: background 0.3s; }
        .slot-inputs { display: flex; gap: 5px; align-items: center; justify-content: center; }
        .slot-inputs input { width: 40px; text-align: center; background: #111; border: 1px solid #555; color: var(--gold); padding: 4px; border-radius: 3px; font-weight: bold; }
        .spell-slot-card.flash { background: #d4af37; }
        .rest-btn { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; }
        .rest-btn:hover { background: #444; color: var(--gold); border-color: var(--gold); }
        .rest-btn.short:hover { color: var(--blue); border-color: var(--blue); }
        .rest-btn.long:hover { color: var(--green); border-color: var(--green); }
        .magic-header-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px dashed #555; padding-bottom: 5px; }
        .magic-header-bar h3 { border: none; margin: 0; padding: 0; }

        /* Inventory */
        .inventory-wrapper { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .currency-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .currency-item input { text-align: center; color: var(--gold); font-weight: bold; background: var(--dark-input); border: 1px solid #444; padding: 5px; border-radius: 4px; }
        .item-list { display: flex; flex-direction: column; gap: 8px; }
        .inv-slot { display: grid; grid-template-columns: 30% 1fr 40px; gap: 10px; background: #2d2d2d; padding: 8px; border-radius: 4px; align-items: start; border-left: 3px solid #555; transition: background 0.2s; }
        .inv-slot input, .inv-slot textarea { background: #1a1a1a; border: 1px solid #444; color: white; padding: 5px; border-radius: 3px; width: 100%; font-family: inherit; }
        .inv-slot textarea { resize: vertical; min-height: 40px; font-size: 0.9em; }

        /* Skills */
        .skill-item { background: #383838; padding: 8px 10px; border-radius: 6px; margin-bottom: 8px; position: relative; border-left: 4px solid var(--green); display: flex; flex-direction: column; gap: 5px; }
        .skill-header { display: flex; gap: 8px; align-items: center; width: 100%; padding-right: 25px; box-sizing: border-box; }
        .skill-name { font-weight: bold; background: #2b2b2b; border: none; flex-grow: 1; padding: 5px; color:white; border-radius: 3px; }
        .skill-cast-box { display: flex; gap: 2px; align-items: center; background: #222; padding: 2px; border-radius: 4px; border: 1px solid #555; }
        .skill-level-input { width: 15px; text-align: center; background: transparent; border: none; color: var(--blue); font-weight: bold; font-size: 0.9rem; }
        .btn-cast { background: var(--blue); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem; padding: 4px 8px; font-weight: bold; transition: 0.2s; }
        .skill-item textarea { width: 97.5%; background: #2b2b2b; border: none; color: #e0e0e0; font-family: inherit; font-size: 0.9rem; box-sizing: border-box; padding: 5px; resize: vertical; min-height: 80px; }
        .skill-controls { position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 2px; z-index: 10; }

        /* Controls */
        .ctrl-btn { background: transparent; border: none; color: #666; cursor: pointer; font-size: 0.9rem; padding: 2px; transition: color 0.2s; }
        .ctrl-btn:hover { color: var(--gold); }
        .ctrl-btn.del:hover { color: var(--red); }
        .add-zone { margin-top: 10px; text-align: center; border: 2px dashed #444; border-radius: 6px; padding: 8px; cursor: pointer; transition: 0.2s; color: #888; font-size: 0.9rem; }
        .add-zone:hover { border-color: var(--gold); color: var(--gold); background: rgba(255,255,255,0.02); }

        label { display: block; font-size: 0.75rem; color: var(--gold); text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; background: var(--dark-input); border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        .notes-area { width: 100%; height: 100%; min-height: 400px; background: #222; border: 1px solid #444; color: #ddd; padding: 15px; border-radius: 8px; font-family: inherit; resize: none; box-sizing: border-box; }

        .controls { display: flex; gap: 10px; margin-top: auto; border-top: 1px solid #444; padding-top: 20px; flex-wrap: wrap; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-transform: uppercase; min-width: 120px; }
        .btn-save { background: var(--gold); color: black; }
        .btn-io { background: var(--blue); color: white; }
        .btn-clear { background: var(--red); color: white; }
        .btn-cloud { background: var(--purple); color: white; }

        /* MODAL STYLES (New) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 20px; border: 1px solid #555; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .modal h2 { color: var(--purple); }
        .modal input { margin-bottom: 10px; width: 100%; }
        .modal p { font-size: 0.8rem; color: #aaa; margin-bottom: 15px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }

        /* === 2. –ú–û–ë–ò–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê (< 800px) === */
        @media screen and (max-width: 800px) {
            body { padding: 5px; }
            .container { padding: 10px; border: none; border-radius: 0; box-shadow: none; }
            .tabs-nav { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 5px; }
            .tab-btn { flex: 0 0 auto; padding: 12px 15px; font-size: 1rem; }
            .header-grid { display: flex; flex-direction: column; align-items: center; }
            .header-main { flex-direction: column; width: 100%; gap: 10px; }
            .avatar-box { flex-shrink: 0; margin-bottom: 10px; }
            .stats-bar { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat-card input.stat-val { width: 100%; text-align: center; }
            .stat-card input.stat-temp { width: 80%; display: block; margin: 0 auto; }
            .stat-row { flex-direction: column; gap: 5px; }
            .vitals-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .vital-box.hp-box { grid-column: span 1; }
            .bonuses-grid, .traits-grid { grid-template-columns: 1fr; }
            .inv-slot { grid-template-columns: 1fr; position: relative; padding-bottom: 40px; }
            .item-controls { position: absolute; bottom: 5px; right: 5px; display: flex; gap: 10px; }
            .ctrl-btn { font-size: 1.2rem; padding: 5px 10px; border: 1px solid #555; background: rgba(0,0,0,0.3); border-radius: 4px; }
            .trait-del { opacity: 1; width: 30px; height: 30px; font-size: 1rem; top: -10px; right: -10px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 5; }
            .spell-grid { grid-template-columns: repeat(3, 1fr); }
            .currency-grid { grid-template-columns: repeat(3, 1fr); }
            .currency-item:last-child { grid-column: span 3; }
            input, textarea, select { font-size: 16px !important; }
            .controls { position: sticky; bottom: 0; background: var(--card); padding-bottom: 15px; z-index: 99; border-top: 2px solid #444; }
            .tab-pane { padding-bottom: 20px; }
            .magic-header-bar { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('main')">üèõÔ∏è –ì–ª–∞–≤–Ω–∞—è</button>
        <button class="tab-btn" onclick="openTab('skills')">‚öîÔ∏è –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</button>
        <button class="tab-btn" onclick="openTab('magic')">üîÆ –ú–∞–≥–∏—è</button>
        <button class="tab-btn" onclick="openTab('inventory')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
        <button class="tab-btn" onclick="openTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>
    </div>

    <div id="main" class="tab-pane active">
        <div class="header-grid">
            <div class="avatar-box" id="avatarDisplay" onclick="document.getElementById('fileInput').click()">
                <span id="uploadHint" style="font-size:0.8rem; text-align:center; color:#777;">–ó–∞–≥—Ä—É–∑–∏—Ç—å<br>–ê–≤–∞—Ç–∞—Ä</span>
            </div>
            <input type="file" id="fileInput" style="display:none" onchange="handleImage(this)">
            
            <div class="header-main">
                <div class="header-inputs">
                    <div style="margin-bottom: 10px;">
                        <label>–ò–º—è –ì–µ—Ä–æ—è</label>
                        <input type="text" id="charName" placeholder="–ò–º—è...">
                    </div>
                    <div>
                        <label>–†–∞—Å–∞ –∏ –ö–ª–∞—Å—Å</label>
                        <input type="text" id="charClass" placeholder="–ö–ª–∞—Å—Å...">
                    </div>
                </div>
                <div class="level-badge">
                    <span class="lvl-title">–£—Ä–æ–≤–µ–Ω—å</span>
                    <span class="lvl-val" id="levelDisplay">1</span>
                    <div class="xp-display">XP: <span id="totalXpDisplay">0</span></div>
                    <div class="xp-control">
                        <input type="number" id="xpInput" placeholder="+XP">
                        <button onclick="addXp()" title="–î–æ–±–∞–≤–∏—Ç—å –æ–ø—ã—Ç">+</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="vitals-grid">
            <div class="vital-box hp-box"><label>–ú–∞–∫—Å. –•–ü</label><input type="number" id="maxHp" value="10"></div>
            <div class="vital-box hp-box"><label>–¢–µ–∫. –•–ü</label><input type="number" id="currHp" value="10"></div>
            <div class="vital-box ac-box"><label>–ë—Ä–æ–Ω—è</label><input type="number" id="armorClass" value="10"></div>
            <div class="vital-box"><label>–°–∫–æ—Ä–æ—Å—Ç—å</label><input type="number" id="speed" value="30"></div>
            <div class="vital-box"><label>–ë–æ–Ω. –ú–∞—Å—Ç.</label><input type="number" id="profBonus" value="2"></div>
        </div>

        <div class="stats-bar">
            <div class="stat-card"><label>–°–ò–õ</label><div class="stat-row"><input type="number" class="stat-val" value="10" oninput="calcMod(this)"><input type="number" class="stat-temp" placeholder="–º–æ–¥" oninput="calcMod(this)"></div><span class="stat-mod">+0</span></div>
            <div class="stat-card"><label>–õ–û–í</label><div class="stat-row"><input type="number" class="stat-val" value="10" oninput="calcMod(this)"><input type="number" class="stat-temp" placeholder="–º–æ–¥" oninput="calcMod(this)"></div><span class="stat-mod">+0</span></div>
            <div class="stat-card"><label>–¢–ï–õ</label><div class="stat-row"><input type="number" class="stat-val" value="10" oninput="calcMod(this)"><input type="number" class="stat-temp" placeholder="–º–æ–¥" oninput="calcMod(this)"></div><span class="stat-mod">+0</span></div>
            <div class="stat-card"><label>–ò–ù–¢</label><div class="stat-row"><input type="number" class="stat-val" value="10" oninput="calcMod(this)"><input type="number" class="stat-temp" placeholder="–º–æ–¥" oninput="calcMod(this)"></div><span class="stat-mod">+0</span></div>
            <div class="stat-card"><label>–ú–£–î</label><div class="stat-row"><input type="number" class="stat-val" value="10" oninput="calcMod(this)"><input type="number" class="stat-temp" placeholder="–º–æ–¥" oninput="calcMod(this)"></div><span class="stat-mod">+0</span></div>
            <div class="stat-card"><label>–•–ê–†</label><div class="stat-row"><input type="number" class="stat-val" value="10" oninput="calcMod(this)"><input type="number" class="stat-temp" placeholder="–º–æ–¥" oninput="calcMod(this)"></div><span class="stat-mod">+0</span></div>
        </div>
    </div>

    <div id="skills" class="tab-pane">
        <h3>‚öîÔ∏è –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</h3>
        <div id="skillsList" style="margin-top:10px"></div>
        <div class="add-zone" onclick="addSkill()">+ –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å</div>
    </div>

    <div id="magic" class="tab-pane">
        <h3>üß© –ë–æ–Ω—É—Å—ã –ø—Ä–æ–≤–µ—Ä–æ–∫</h3>
        <div class="bonuses-grid" id="bonusList"></div>
        <div class="add-zone" onclick="addBonus()" style="margin-bottom: 20px;">+ –ë–æ–Ω—É—Å (–ù–∞–ø—Ä–∏–º–µ—Ä: –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ +5)</div>

        <h3>‚ú® –ß–µ—Ä—Ç—ã –∏ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</h3>
        <div class="traits-grid" id="traitsList"></div>
        <div class="add-zone" onclick="addTrait()">+ –î–æ–±–∞–≤–∏—Ç—å –ß–µ—Ä—Ç—É</div>

        <div class="magic-header-bar">
            <h3>üîÆ –Ø—á–µ–π–∫–∏ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–π</h3>
            <div style="display: flex; gap: 10px;">
                <button class="rest-btn short" onclick="shortRest()">‚òï –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–¥—ã—Ö</button>
                <button class="rest-btn long" onclick="longRest()">‚õ∫ –î–æ–ª–≥–∏–π –æ—Ç–¥—ã—Ö</button>
            </div>
        </div>
        <div class="spells-wrapper">
            <div class="spell-grid" id="spellSlotsContainer"></div>
        </div>
    </div>

    <div id="inventory" class="tab-pane">
        <div class="inventory-wrapper">
            <div class="currency-grid">
                <div class="currency-item"><label>pp</label><input type="number" id="curr-pp" placeholder="0"></div>
                <div class="currency-item"><label>gp</label><input type="number" id="curr-gp" placeholder="0"></div>
                <div class="currency-item"><label>sp</label><input type="number" id="curr-sp" placeholder="0"></div>
                <div class="currency-item"><label>cp</label><input type="number" id="curr-cp" placeholder="0"></div>
                <div class="currency-item"><label>–ú–æ–Ω–µ—Ç—ã –¥—É—à</label><input type="text" id="curr-custom" placeholder="..."></div>
            </div>
            <label style="margin-top:10px;">–ü—Ä–µ–¥–º–µ—Ç—ã</label>
            <div id="inventoryList" class="item-list"></div>
            <div class="add-zone" onclick="addItem()">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</div>
        </div>
    </div>

    <div id="notes" class="tab-pane">
        <textarea id="charNotes" class="notes-area" placeholder="–í–∞–∂–Ω—ã–µ –∑–∞–ø–∏—Å–∏..."></textarea>
    </div>

    <div class="controls">
        <button class="btn btn-save" onclick="saveCharacter()">üíæ Save to browser</button>
        <button class="btn btn-cloud" onclick="toggleCloudModal()">‚òÅÔ∏è Sync</button>
        <button class="btn btn-io" onclick="exportToFile()">‚¨áÔ∏è Export</button>
        <button class="btn btn-io" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import</button>
        <input type="file" id="importFile" style="display:none" onchange="importFromFile(this)">
        <button class="btn btn-clear" onclick="clearCharacter()">üóëÔ∏è Clear</button>
    </div>
</div>

<div id="cloudModal" class="modal">
    <div class="modal-content">
        <h2>GitHub Sync</h2>
        <p>–ù—É–∂–µ–Ω Gist ID –∏ Token (—Å –ø—Ä–∞–≤–∞–º–∏ 'gist'). –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
        <input type="password" id="ghToken" placeholder="GitHub Token (ghp_...)" onchange="saveCloudConfig()">
        <input type="text" id="gistId" placeholder="Gist ID (–¥–ª–∏–Ω–Ω—ã–π –∫–æ–¥ –∏–∑ URL)" onchange="saveCloudConfig()">
        <div class="modal-btns">
            <button class="btn btn-io" onclick="loadFromCloud()">‚òÅÔ∏è LoadFromCloud</button>
            <button class="btn btn-save" onclick="uploadToCloud()">‚òÅÔ∏è UploadToCloud</button>
        </div>
        <button class="btn btn-clear" style="margin-top:10px" onclick="toggleCloudModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
    // --- TABS ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => {
            if(b.getAttribute('onclick').includes(tabId)) b.classList.add('active');
        });
    }

    // --- XP LOGIC ---
    let globalXp = 0;
    const xpTable = [
        { lvl: 20, xp: 355000 }, { lvl: 19, xp: 305000 }, { lvl: 18, xp: 265000 }, { lvl: 17, xp: 225000 },
        { lvl: 16, xp: 195000 }, { lvl: 15, xp: 165000 }, { lvl: 14, xp: 140000 }, { lvl: 13, xp: 120000 },
        { lvl: 12, xp: 100000 }, { lvl: 11, xp: 85000 }, { lvl: 10, xp: 64000 }, { lvl: 9, xp: 48000 },
        { lvl: 8, xp: 34000 }, { lvl: 7, xp: 23000 }, { lvl: 6, xp: 14000 }, { lvl: 5, xp: 6500 },
        { lvl: 4, xp: 2700 }, { lvl: 3, xp: 900 }, { lvl: 2, xp: 300 }, { lvl: 1, xp: 0 }
    ];
    function updateLevelUI() {
        document.getElementById('totalXpDisplay').innerText = globalXp.toLocaleString();
        let level = 1;
        for (let step of xpTable) {
            if (globalXp >= step.xp) {
                level = step.lvl;
                break;
            }
        }
        document.getElementById('levelDisplay').innerText = level;
    }
    function addXp() {
        const input = document.getElementById('xpInput');
        const val = parseInt(input.value);
        if (!isNaN(val)) {
            globalXp += val;
            if (globalXp < 0) globalXp = 0;
            updateLevelUI();
            input.value = '';
        }
    }

    // --- REORDER ---
    function moveUp(btn) {
        const item = btn.closest('.inv-slot') || btn.closest('.skill-item');
        if (item && item.previousElementSibling) item.parentNode.insertBefore(item, item.previousElementSibling);
    }
    function moveDown(btn) {
        const item = btn.closest('.inv-slot') || btn.closest('.skill-item');
        if (item && item.nextElementSibling) item.parentNode.insertBefore(item.nextElementSibling, item);
    }

    // --- MAGIC & REST ---
    function initSpellSlots() {
        const container = document.getElementById('spellSlotsContainer');
        const levels = ["–ü–∞–∫—Ç", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
        let html = '';
        levels.forEach((lvl, index) => {
            let key = index === 0 ? 'pact' : 'lvl' + index;
            html += `
                <div class="spell-slot-card" data-key="${key}">
                    <label style="border-bottom:1px solid #444; padding-bottom:2px; margin-bottom:4px; color:#aaa; font-size:0.7rem">${lvl}</label>
                    <div class="slot-inputs">
                        <input type="number" class="slot-current" placeholder="0"> <span style="color:#666">/</span>
                        <input type="number" class="slot-max" placeholder="0">
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    }
    initSpellSlots();

    function longRest() {
        if(!confirm("–°–æ–≤–µ—Ä—à–∏—Ç—å –î–æ–ª–≥–∏–π –æ—Ç–¥—ã—Ö? (–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—Å–µ –•–ü –∏ —è—á–µ–π–∫–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π)")) return;
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –•–ü
        const maxHp = document.getElementById('maxHp').value;
        if(maxHp) document.getElementById('currHp').value = maxHp;

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —è—á–µ–µ–∫
        document.querySelectorAll('.spell-slot-card').forEach(card => {
            const max = card.querySelector('.slot-max').value;
            if(max) card.querySelector('.slot-current').value = max;
        });

        saveCharacter();
        alert("‚õ∫ –í—ã –æ—Ç–ª–∏—á–Ω–æ –≤—ã—Å–ø–∞–ª–∏—Å—å! –•–ü –∏ —è—á–µ–π–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.");
    }

    function shortRest() {
        if(!confirm("–°–æ–≤–µ—Ä—à–∏—Ç—å –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–¥—ã—Ö? (–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç —è—á–µ–π–∫–∏ –ü–∞–∫—Ç–∞)")) return;

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —è—á–µ–µ–∫ –ü–∞–∫—Ç–∞
        const pactCard = document.querySelector('.spell-slot-card[data-key="pact"]');
        if(pactCard) {
            const max = pactCard.querySelector('.slot-max').value;
            if(max) pactCard.querySelector('.slot-current').value = max;
        }

        saveCharacter();
        alert("‚òï –í—ã –ø–µ—Ä–µ–≤–µ–ª–∏ –¥—É—Ö. –Ø—á–µ–π–∫–∏ –ü–∞–∫—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.");
    }

    function useSpellSlot(btn) {
        const row = btn.closest('.skill-header');
        const lvlInput = row.querySelector('.skill-level-input');
        const lvl = parseInt(lvlInput.value);

        if (isNaN(lvl) || lvl < 0 || lvl > 9) {
            alert("–£–∫–∞–∂–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —è—á–µ–π–∫–∏ (0-9)");
            return;
        }
        if (lvl === 0) {
            flashBtn(btn);
            return; 
        }

        const key = 'lvl' + lvl;
        const slotCard = document.querySelector(`.spell-slot-card[data-key="${key}"]`);
        if (!slotCard) { alert("–û—à–∏–±–∫–∞ —è—á–µ–µ–∫"); return; }

        const currInput = slotCard.querySelector('.slot-current');
        let currentVal = parseInt(currInput.value) || 0;

        if (currentVal > 0) {
            currInput.value = currentVal - 1;
            flashBtn(btn);
            slotCard.classList.add('flash');
            setTimeout(() => slotCard.classList.remove('flash'), 1000);
            saveCharacter(); 
        } else {
            alert(`–ù–µ—Ç —è—á–µ–µ–∫ ${lvl} —É—Ä–æ–≤–Ω—è!`);
        }
    }

    function flashBtn(btn) {
        btn.style.background = "#27ae60";
        btn.innerText = "‚úì";
        setTimeout(() => { btn.style.background = ""; btn.innerText = "Cast"; }, 1000);
    }

    function calcMod(input) {
        const card = input.closest('.stat-card');
        const base = parseInt(card.querySelector('.stat-val').value) || 0;
        const temp = parseInt(card.querySelector('.stat-temp').value) || 0;
        const baseMod = Math.floor((base - 10) / 2);
        const totalMod = baseMod + temp;
        card.querySelector('.stat-mod').innerText = (totalMod >= 0 ? '+' : '') + totalMod;
    }

    // --- DOM GENERATORS ---
    function addItem(name = '', desc = '') {
        const div = document.createElement('div');
        div.className = 'inv-slot';
        div.innerHTML = `
            <input type="text" class="item-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${name}">
            <textarea class="item-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ...">${desc}</textarea>
            <div class="item-controls">
                <button class="ctrl-btn" onclick="moveUp(this)">‚ñ≤</button>
                <button class="ctrl-btn del" onclick="this.closest('.inv-slot').remove()">‚úñ</button>
                <button class="ctrl-btn" onclick="moveDown(this)">‚ñº</button>
            </div>`;
        document.getElementById('inventoryList').appendChild(div);
    }
    function addSkill(name = '', desc = '', cost = '') {
        const div = document.createElement('div');
        div.className = 'skill-item';
        div.innerHTML = `
            <div class="skill-controls">
                <button class="ctrl-btn" onclick="moveUp(this)">‚ñ≤</button>
                <button class="ctrl-btn del" onclick="this.closest('.skill-item').remove()">‚úñ</button>
                <button class="ctrl-btn" onclick="moveDown(this)">‚ñº</button>
            </div>
            <div class="skill-header">
                <input type="text" class="skill-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${name}">
                <div class="skill-cast-box">
                    <input type="number" class="skill-level-input" placeholder="Lvl" value="${cost}">
                    <button class="btn-cast" onclick="useSpellSlot(this)">Cast</button>
                </div>
            </div>
            <textarea placeholder="–î–µ—Ç–∞–ª–∏...">${desc}</textarea>`;
        document.getElementById('skillsList').appendChild(div);
    }
    function addBonus(name = '', val = '') {
        const div = document.createElement('div');
        div.className = 'bonus-item';
        div.innerHTML = `
            <input type="text" class="bonus-name" placeholder="–ù–∞–≤—ã–∫" value="${name}">
            <input type="number" class="bonus-val" placeholder="+0" value="${val}">
            <button class="ctrl-btn del" onclick="this.closest('.bonus-item').remove()">‚úñ</button>
        `;
        document.getElementById('bonusList').appendChild(div);
    }
    function addTrait(name = '', desc = '') {
        const div = document.createElement('div');
        div.className = 'trait-card';
        div.innerHTML = `
            <button class="trait-del" onclick="this.closest('.trait-card').remove()">‚úñ</button>
            <input type="text" class="trait-name" placeholder="–ß–µ—Ä—Ç–∞" value="${name}">
            <textarea class="trait-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ...">${desc}</textarea>
        `;
        document.getElementById('traitsList').appendChild(div);
    }

    let avatarBase64 = "";
    function handleImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                avatarBase64 = e.target.result;
                document.getElementById('avatarDisplay').style.backgroundImage = `url(${avatarBase64})`;
                document.getElementById('uploadHint').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- DATA ---
    function gatherData() {
        const items = [];
        document.querySelectorAll('.inv-slot').forEach(r => items.push({ name: r.querySelector('.item-name').value, desc: r.querySelector('.item-desc').value }));
        const skills = [];
        document.querySelectorAll('.skill-item').forEach(i => skills.push({ 
            name: i.querySelector('.skill-name').value, 
            desc: i.querySelector('textarea').value,
            cost: i.querySelector('.skill-level-input').value
        }));
        const bonuses = [];
        document.querySelectorAll('.bonus-item').forEach(b => bonuses.push({ name: b.querySelector('.bonus-name').value, val: b.querySelector('.bonus-val').value }));
        const traits = [];
        document.querySelectorAll('.trait-card').forEach(t => traits.push({ name: t.querySelector('.trait-name').value, desc: t.querySelector('.trait-desc').value }));
        const stats = Array.from(document.querySelectorAll('.stat-card .stat-val')).map(i => i.value);
        const statsTemp = Array.from(document.querySelectorAll('.stat-card .stat-temp')).map(i => i.value);
        const spellData = {};
        document.querySelectorAll('.spell-slot-card').forEach(c => {
            spellData[c.getAttribute('data-key')] = { curr: c.querySelector('.slot-current').value, max: c.querySelector('.slot-max').value };
        });

        return {
            name: document.getElementById('charName').value,
            class: document.getElementById('charClass').value,
            maxHp: document.getElementById('maxHp').value,
            currHp: document.getElementById('currHp').value,
            armorClass: document.getElementById('armorClass').value,
            speed: document.getElementById('speed').value,
            profBonus: document.getElementById('profBonus').value,
            totalXp: globalXp,
            currency: {
                pp: document.getElementById('curr-pp').value, gp: document.getElementById('curr-gp').value,
                sp: document.getElementById('curr-sp').value, cp: document.getElementById('curr-cp').value,
                custom: document.getElementById('curr-custom').value
            },
            stats, statsTemp, items, skills, bonuses, traits, spells: spellData, 
            notes: document.getElementById('charNotes').value, avatar: avatarBase64
        };
    }

    function saveCharacter() {
        const data = gatherData();
        localStorage.setItem('dnd_char_v9', JSON.stringify(data)); 
        const btn = document.querySelector('.btn-save');
        btn.innerText = "‚úì";
        setTimeout(() => btn.innerText = "üíæ Save", 1500);
    }

    function loadCharacter(data = null) {
        if(!data) {
            const json = localStorage.getItem('dnd_char_v9') || localStorage.getItem('dnd_char_v8');
            if (!json) return;
            data = JSON.parse(json);
        }
        document.getElementById('charName').value = data.name || '';
        document.getElementById('charClass').value = data.class || '';
        document.getElementById('maxHp').value = data.maxHp || 10;
        document.getElementById('currHp').value = data.currHp || 10;
        document.getElementById('armorClass').value = data.armorClass || 10;
        document.getElementById('speed').value = data.speed || 30;
        document.getElementById('profBonus').value = data.profBonus || 2;
        document.getElementById('charNotes').value = data.notes || '';
        globalXp = data.totalXp || 0;
        updateLevelUI();

        if (data.currency) ['pp','gp','sp','cp','custom'].forEach(k => document.getElementById('curr-'+k).value = data.currency[k] || '');
        const statInputs = document.querySelectorAll('.stat-card .stat-val');
        const statTemps = document.querySelectorAll('.stat-card .stat-temp');
        if (data.stats) data.stats.forEach((v, i) => { if(statInputs[i]) statInputs[i].value = v; });
        if (data.statsTemp) data.statsTemp.forEach((v, i) => { if(statTemps[i]) statTemps[i].value = v; });
        statInputs.forEach(input => calcMod(input));

        if (data.spells) {
            document.querySelectorAll('.spell-slot-card').forEach(card => {
                const key = card.getAttribute('data-key');
                if (data.spells[key]) {
                    card.querySelector('.slot-current').value = data.spells[key].curr;
                    card.querySelector('.slot-max').value = data.spells[key].max;
                }
            });
        }
        if (data.avatar) {
            avatarBase64 = data.avatar;
            document.getElementById('avatarDisplay').style.backgroundImage = `url(${data.avatar})`;
            document.getElementById('uploadHint').style.display = 'none';
        }

        document.getElementById('inventoryList').innerHTML = '';
        if (data.items) data.items.forEach(item => addItem(item.name, item.desc));
        document.getElementById('skillsList').innerHTML = '';
        if (data.skills) data.skills.forEach(s => addSkill(s.name, s.desc, s.cost));
        document.getElementById('bonusList').innerHTML = '';
        if (data.bonuses) data.bonuses.forEach(b => addBonus(b.name, b.val));
        document.getElementById('traitsList').innerHTML = '';
        if (data.traits) data.traits.forEach(t => addTrait(t.name, t.desc));
    }

    // --- CLOUD SYNC LOGIC ---
    function toggleCloudModal() {
        const m = document.getElementById('cloudModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        // Load config
        if(localStorage.getItem('gh_token')) document.getElementById('ghToken').value = localStorage.getItem('gh_token');
        if(localStorage.getItem('gh_gist')) document.getElementById('gistId').value = localStorage.getItem('gh_gist');
    }

    function saveCloudConfig() {
        const t = document.getElementById('ghToken').value.trim();
        const g = document.getElementById('gistId').value.trim();
        if(t) localStorage.setItem('gh_token', t);
        if(g) localStorage.setItem('gh_gist', g);
    }

    async function uploadToCloud() {
        const token = localStorage.getItem('gh_token');
        const gistId = localStorage.getItem('gh_gist');
        if(!token || !gistId) { alert("–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ Token –∏ Gist ID!"); return; }

        const data = gatherData();
        const btn = document.querySelector('.btn-save'); 

        try {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'hero.json': {
                            content: JSON.stringify(data)
                        }
                    }
                })
            });

            if(res.ok) {
                alert("–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ! ‚òÅÔ∏è");
                toggleCloudModal();
            } else {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –∏ ID.");
                console.error(await res.json());
            }
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!");
        }
    }

    async function loadFromCloud() {
        const token = localStorage.getItem('gh_token');
        const gistId = localStorage.getItem('gh_gist');
        if(!token || !gistId) { alert("–£–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!"); return; }

        try {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            
            if(res.ok) {
                const json = await res.json();
                if(json.files && json.files['hero.json']) {
                    const charData = JSON.parse(json.files['hero.json'].content);
                    loadCharacter(charData);
                    saveCharacter(); 
                    alert("–ü–µ—Ä—Å–æ–Ω–∞–∂ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –æ–±–ª–∞–∫–∞! ‚òÅÔ∏è");
                    toggleCloudModal();
                } else {
                    alert("–í —ç—Ç–æ–º Gist –Ω–µ—Ç —Ñ–∞–π–ª–∞ hero.json!");
                }
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è!");
            }
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞!");
            console.error(e);
        }
    }

    function exportToFile() {
        const data = gatherData();
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 19).replace('T', '_').replace(/:/g, '-');
        a.href = url;
        a.download = `hero_${data.name || 'unnamed'}_${timestamp}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
    function importFromFile(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    loadCharacter(data);
                    saveCharacter(); 
                    alert("–ó–∞–≥—Ä—É–∂–µ–Ω–æ!");
                } catch(err) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞!"); }
            };
            reader.readAsText(input.files[0]);
        }
        input.value = ''; 
    }
    function clearCharacter() {
        if(confirm('–£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?')) {
            localStorage.removeItem('dnd_char_v9');
            location.reload();
        }
    }

    window.onload = () => loadCharacter();
</script>
</body>
</html>